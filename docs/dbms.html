<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Database tidbits &amp; SQL snippets">

<title>DBMS</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title"><a class="navbar-brand" href="index.html"><img src="static/logo.svg" width="32px" height="32px" class="d-inline-block align-text-top"></a></span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-development" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Development</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-development">    
        <li>
    <a class="dropdown-item" href="./rstudio.html">
 <span class="dropdown-text">RStudio</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./python.html">
 <span class="dropdown-text">Python</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./dm.html">
 <span class="dropdown-text">Data Management</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./cli.html">
 <span class="dropdown-text">CLI</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./dbms.html">
 <span class="dropdown-text">DBMS</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./resources.html">
 <span class="dropdown-text">Resources</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-health--fitness" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Health &amp; Fitness</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-health--fitness">    
        <li>
    <a class="dropdown-item" href="./workouts.html">
 <span class="dropdown-text">Workouts</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./food.html">
 <span class="dropdown-text">Food</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://geocoug.github.io">
 <span class="menu-text"><i class="fa-brands fa-github fa-xl" aria-label="github"></i></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/caleb-grant-04b098101">
 <span class="menu-text"><i class="fa-brands fa-linkedin fa-xl" aria-label="linkedin"></i></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://jupyter.geocoug.com">
 <span class="menu-text"><i class="fa-brands fa-python fa-xl" aria-label="python"></i></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://rstudio.geocoug.com">
 <span class="menu-text"><i class="fa-brands fa-r-project fa-xl" aria-label="r-project"></i></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#postgresql" id="toc-postgresql" class="nav-link active" data-scroll-target="#postgresql">PostgreSQL</a>
  <ul class="collapse">
  <li><a href="#pg_dump" id="toc-pg_dump" class="nav-link" data-scroll-target="#pg_dump">pg_dump</a></li>
  <li><a href="#primary-key-relationships" id="toc-primary-key-relationships" class="nav-link" data-scroll-target="#primary-key-relationships">Primary Key Relationships</a></li>
  <li><a href="#foreign-key-relationships" id="toc-foreign-key-relationships" class="nav-link" data-scroll-target="#foreign-key-relationships">Foreign Key Relationships</a></li>
  <li><a href="#ordering-tables-by-fk" id="toc-ordering-tables-by-fk" class="nav-link" data-scroll-target="#ordering-tables-by-fk">Ordering Tables by FK</a></li>
  <li><a href="#create-db" id="toc-create-db" class="nav-link" data-scroll-target="#create-db">Create DB</a></li>
  <li><a href="#dblink" id="toc-dblink" class="nav-link" data-scroll-target="#dblink">DBLink</a></li>
  <li><a href="#partitioning" id="toc-partitioning" class="nav-link" data-scroll-target="#partitioning">Partitioning</a></li>
  <li><a href="#temporary-objects" id="toc-temporary-objects" class="nav-link" data-scroll-target="#temporary-objects">Temporary Objects</a></li>
  <li><a href="#table-relationships" id="toc-table-relationships" class="nav-link" data-scroll-target="#table-relationships">Table Relationships</a></li>
  <li><a href="#current-database" id="toc-current-database" class="nav-link" data-scroll-target="#current-database">Current Database</a></li>
  <li><a href="#current-userrole" id="toc-current-userrole" class="nav-link" data-scroll-target="#current-userrole">Current user/role</a></li>
  <li><a href="#process-id" id="toc-process-id" class="nav-link" data-scroll-target="#process-id">Process ID</a></li>
  <li><a href="#list-functionsdefsargs" id="toc-list-functionsdefsargs" class="nav-link" data-scroll-target="#list-functionsdefsargs">List functions/defs/args</a></li>
  <li><a href="#whos-logged-in" id="toc-whos-logged-in" class="nav-link" data-scroll-target="#whos-logged-in">Whos logged in</a></li>
  <li><a href="#aggregate-functions" id="toc-aggregate-functions" class="nav-link" data-scroll-target="#aggregate-functions">Aggregate Functions</a></li>
  <li><a href="#list-users" id="toc-list-users" class="nav-link" data-scroll-target="#list-users">List users</a></li>
  <li><a href="#list-tables-in-database" id="toc-list-tables-in-database" class="nav-link" data-scroll-target="#list-tables-in-database">List tables in database</a></li>
  <li><a href="#list-columns-in-table" id="toc-list-columns-in-table" class="nav-link" data-scroll-target="#list-columns-in-table">List columns in table</a></li>
  <li><a href="#update-from" id="toc-update-from" class="nav-link" data-scroll-target="#update-from">Update From</a></li>
  <li><a href="#materialized-view" id="toc-materialized-view" class="nav-link" data-scroll-target="#materialized-view">Materialized View</a></li>
  <li><a href="#constants" id="toc-constants" class="nav-link" data-scroll-target="#constants">Constants</a></li>
  <li><a href="#sequential-keys" id="toc-sequential-keys" class="nav-link" data-scroll-target="#sequential-keys">Sequential Keys</a></li>
  <li><a href="#cross-database-search" id="toc-cross-database-search" class="nav-link" data-scroll-target="#cross-database-search">Cross-Database Search</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">DBMS</h1>
</div>

<div>
  <div class="description">
    Database tidbits &amp; SQL snippets
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="postgresql" class="level1">
<h1>PostgreSQL</h1>
<section id="pg_dump" class="level2">
<h2 class="anchored" data-anchor-id="pg_dump">pg_dump</h2>
<p><a href="https://www.postgresql.org/docs/12/app-pgdump.html">Reference</a></p>
<p><code>pg_dump -h [host] -d [database] -U [user] -s [schema only] -W [force password] &gt; &lt;file&gt;.sql</code></p>
</section>
<section id="primary-key-relationships" class="level2">
<h2 class="anchored" data-anchor-id="primary-key-relationships">Primary Key Relationships</h2>
<p><strong>Columns</strong></p>
<ul>
<li>table_schema: PK schema name</li>
<li>table_name: PK table name</li>
<li>constraint_name: PK constraint name</li>
<li>position: index of column in table (1, 2, …). 2 or higher means key is composite (contains more than one column)</li>
<li>key_column: PK column name</li>
</ul>
<p><strong>Rows</strong></p>
<ul>
<li>One row represents one primary key column</li>
<li>Scope of rows: columns of all PK constraints in a database</li>
<li>Ordered by table schema, table name, column position</li>
</ul>
<pre class="{sql}"><code>select * from (
    -- Main query. Returns all tables
    select kcu.table_schema,
           kcu.table_name,
           tco.constraint_name,
           kcu.ordinal_position as position,
           kcu.column_name as key_column
    from information_schema.table_constraints tco
    join information_schema.key_column_usage kcu 
         on kcu.constraint_name = tco.constraint_name
         and kcu.constraint_schema = tco.constraint_schema
         and kcu.constraint_name = tco.constraint_name
    where tco.constraint_type = 'PRIMARY KEY'
    order by kcu.table_schema,
             kcu.table_name,
             position
) main
where table_name = 'd_location'</code></pre>
</section>
<section id="foreign-key-relationships" class="level2">
<h2 class="anchored" data-anchor-id="foreign-key-relationships">Foreign Key Relationships</h2>
<p><strong>Columns</strong></p>
<ul>
<li>foreign_table: foreign table schema and name</li>
<li>rel: relationship symbol implicating direction</li>
<li>primary_table: primary (rerefenced) table schema and name</li>
<li>fk_columns: list of FK colum names, separated with “,”</li>
<li>constraint_name: foreign key constraint name</li>
</ul>
<p><strong>Rows</strong></p>
<ul>
<li>One row represents one foreign key.</li>
<li>If foreign key consists of multiple columns (composite key) it is still represented as one row.</li>
<li>Scope of rows: all foregin keys in a database.</li>
<li>Ordered by foreign table schema name and table name.</li>
</ul>
</section>
<section id="ordering-tables-by-fk" class="level2">
<h2 class="anchored" data-anchor-id="ordering-tables-by-fk">Ordering Tables by FK</h2>
<pre class="{sql}"><code>drop table if exists dependencies cascade;
create temporary table dependencies as
select 
        tc.table_name as child,
        tu.table_name as parent
from 
        information_schema.table_constraints as tc
        inner join information_schema.constraint_table_usage as tu
             on tu.constraint_name = tc.constraint_name
where 
        tc.constraint_type = 'FOREIGN KEY'
        and tc.table_name &lt;&gt; tu.table_name;

with recursive dep_depth as (
 select
  dep.child,
  dep.parent,
  1 as lvl
 from
  dependencies as dep
 union all
 select
  dep.child,
  dep.parent,
  dd.lvl + 1 as lvl
 from
  dep_depth as dd
  inner join dependencies as dep on dep.parent = dd.child
 )
select
 table_name,
 table_order
from (
 select
  dd.parent as table_name,
  max(lvl) as table_order
 from
  dep_depth as dd
 group by
  table_name
 union
 select
  dd.child as table_name,
  max(lvl) + 1 as level
 from
  dep_depth as dd
  left join dependencies as dp on dp.parent = dd.child
 where
  dp.parent is null
 group by
  dd.child
 ) as all_levels
 order by table_order;</code></pre>
<pre class="{sql}"><code>select * from (
    -- Main query. Returns FK relationships for all tables
    select 
            kcu.table_schema as table_schema,
            kcu.table_name as foreign_table,
           '&gt;-' as relationship,
           rel_tco.table_name as primary_table,
           string_agg(kcu.column_name, ', ') as fk_columns,
           kcu.constraint_name
    from information_schema.table_constraints tco
    join information_schema.key_column_usage kcu
              on tco.constraint_schema = kcu.constraint_schema
              and tco.constraint_name = kcu.constraint_name
    join information_schema.referential_constraints rco
              on tco.constraint_schema = rco.constraint_schema
              and tco.constraint_name = rco.constraint_name
    join information_schema.table_constraints rel_tco
              on rco.unique_constraint_schema = rel_tco.constraint_schema
              and rco.unique_constraint_name = rel_tco.constraint_name
    where tco.constraint_type = 'FOREIGN KEY'
    group by kcu.table_schema,
             kcu.table_name,
             rel_tco.table_name,
             rel_tco.table_schema,
             kcu.constraint_name
    order by kcu.table_schema,
             kcu.table_name
) main
where primary_table = 'd_location'</code></pre>
</section>
<section id="create-db" class="level2">
<h2 class="anchored" data-anchor-id="create-db">Create DB</h2>
<pre class="{sql}"><code>create database &lt;new_db_name&gt; owner &lt;user_or_group&gt; template &lt;name_of_db_to_use_as_template&gt;;
-- show search_path;
set search_path to &lt;default_schema&gt;,public;
create extension if not exists postgis;
create extension if not exists dblink;


-- Database Creation
-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
create database &lt;new_db_name&gt; owner &lt;user_or_group&gt; template &lt;name_of_db_to_use_as_template&gt;;
-- show search_path;
set search_path to idb, public;

grant connect, temporary on database &lt;new_db_name&gt; to public;
grant all on database &lt;new_db_name&gt; to &lt;user&gt;;
grant all on database &lt;new_db_name&gt; to &lt;group&gt;;

create extension if not exists postgis;
create extension if not exists dblink;

create schema staging;

-- Add a unique constraint to e_analyte.full_name and e_analyte.cas_rn so that
--  no full name or cas_rn can be used for more than one analyte
-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
alter table e_analyte
  add constraint uc_fullname unique(full_name),
  add constraint uc_casrn unique(cas_rn);</code></pre>
</section>
<section id="dblink" class="level2">
<h2 class="anchored" data-anchor-id="dblink">DBLink</h2>
<pre class="{sql}"><code>select
  a.*, b.*
from
  table1 as a
  left join (
    select * from dblink(
      'dbname=&lt;database&gt;',
      'select col1, col2, col3 from &lt;table&gt;'
    ) as d (
      col1 text, col2 text, col3 text
    )
  ) as b
  on a.col1 = b.col2</code></pre>
</section>
<section id="partitioning" class="level2">
<h2 class="anchored" data-anchor-id="partitioning">Partitioning</h2>
<p><code>{sql, eval=F, inclute=T, class.source='fold-show'} select * from (     select *, row_number() over(         partition by             col1, col2, col3         order by col1 desc     ) rowid     from sometable ) someid where rowid &gt; 1;</code></p>
</section>
<section id="temporary-objects" class="level2">
<h2 class="anchored" data-anchor-id="temporary-objects">Temporary Objects</h2>
<p><code>{sql, eval=F, inclute=T, class.source='fold-show'} SELECT     n.nspname as SchemaName,     c.relname as RelationName,     CASE c.relkind         WHEN 'r' THEN 'table'         WHEN 'v' THEN 'view'         WHEN 'i' THEN 'index'         WHEN 'S' THEN 'sequence'         WHEN 's' THEN 'special'         END as RelationType,     pg_catalog.pg_get_userbyid(c.relowner) as RelationOwner,                  pg_size_pretty(pg_relation_size(n.nspname ||'.'|| c.relname)) as RelationSize FROM pg_catalog.pg_class c LEFT JOIN pg_catalog.pg_namespace AS n ON n.oid = c.relnamespace     WHERE  c.relkind IN ('r','s')      AND  (n.nspname !~ '^pg_toast' and nspname like 'pg_temp%') ORDER BY pg_relation_size(n.nspname ||'.'|| c.relname) DESC;</code></p>
</section>
<section id="table-relationships" class="level2">
<h2 class="anchored" data-anchor-id="table-relationships">Table Relationships</h2>
<p><a href="https://dataedo.com/kb/query/postgresql/list-tables-with-most-relationships">https://dataedo.com/kb/query/postgresql/list-tables-with-most-relationships</a></p>
<pre class="{sql}"><code>select * from
(select relations.table_name as table_name, -- schema name and table name
       count(relations.table_name) as relationships, -- number of table relationships
       count(relations.referenced_tables) as foreign_keys, -- number of foreign keys in a table
       count(relations.referencing_tables) as references, -- number of foreign keys that are refering to this table
       count(distinct related_table) as related_tables, -- number of related tables
       count(distinct relations.referenced_tables) as referenced_tables, -- number of different tables referenced with FKs (multiple FKs can refer to one table, so number of FKs might be different than number of referenced tables)
       count(distinct relations.referencing_tables) as referencing_tables -- number of different tables that are refering to this table (similar to referenced_tables)
from(
     select pk_tco.table_schema || '.' || pk_tco.table_name as table_name,
            fk_tco.table_schema || '.' || fk_tco.table_name as related_table,
            fk_tco.table_name as referencing_tables,
            null::varchar(100) as referenced_tables
     from information_schema.referential_constraints rco
     join information_schema.table_constraints fk_tco
          on rco.constraint_name = fk_tco.constraint_name
          and rco.constraint_schema = fk_tco.table_schema
     join information_schema.table_constraints pk_tco
          on rco.unique_constraint_name = pk_tco.constraint_name
          and rco.unique_constraint_schema = pk_tco.table_schema
    union all
    select fk_tco.table_schema || '.' || fk_tco.table_name as table_name,
           pk_tco.table_schema || '.' || pk_tco.table_name as related_table,
           null as referencing_tables,
           pk_tco.table_name as referenced_tables
    from information_schema.referential_constraints rco
    join information_schema.table_constraints fk_tco 
         on rco.constraint_name = fk_tco.constraint_name
         and rco.constraint_schema = fk_tco.table_schema
    join information_schema.table_constraints pk_tco
         on rco.unique_constraint_name = pk_tco.constraint_name
         and rco.unique_constraint_schema = pk_tco.table_schema
) relations
group by table_name
order by relationships asc) results

where substring(table_name, 5, 2) = 'd_'; -- substring(string, start_position, length)</code></pre>
</section>
<section id="current-database" class="level2">
<h2 class="anchored" data-anchor-id="current-database">Current Database</h2>
<pre class="{sql}"><code>select * from pg_catalog.current_database()</code></pre>
</section>
<section id="current-userrole" class="level2">
<h2 class="anchored" data-anchor-id="current-userrole">Current user/role</h2>
<pre class="{sql}"><code>select * from current_role
select * from current_user</code></pre>
</section>
<section id="process-id" class="level2">
<h2 class="anchored" data-anchor-id="process-id">Process ID</h2>
<pre class="{sql}"><code>select * from pg_catalog.pg_backend_pid()</code></pre>
</section>
<section id="list-functionsdefsargs" class="level2">
<h2 class="anchored" data-anchor-id="list-functionsdefsargs">List functions/defs/args</h2>
<pre class="{sql}"><code>select 
    pg_get_userbyid(p.proowner) as owner,
    n.nspname as function_schema,
    p.proname as function_name,
    l.lanname as function_language,
    case when l.lanname = 'internal' then p.prosrc
        else pg_get_functiondef(p.oid)
        end as definition,
    pg_get_function_arguments(p.oid) as function_arguments,
    t.typname as return_type
from pg_proc p
    left join pg_namespace n on p.pronamespace = n.oid
    left join pg_language l on p.prolang = l.oid
    left join pg_type t on t.oid = p.prorettype 
where n.nspname not in ('pg_catalog', 'information_schema')
and n.nspname = 'idb'
order by function_schema, function_name;</code></pre>
</section>
<section id="whos-logged-in" class="level2">
<h2 class="anchored" data-anchor-id="whos-logged-in">Whos logged in</h2>
<pre class="{sql}"><code>select * from pg_stat_activity
where usename != '' and usename != 'postgres'
order by usename, pid</code></pre>
</section>
<section id="aggregate-functions" class="level2">
<h2 class="anchored" data-anchor-id="aggregate-functions">Aggregate Functions</h2>
<p><a href="https://www.postgresql.org/docs/9.6/catalog-pg-aggregate.html">https://www.postgresql.org/docs/9.6/catalog-pg-aggregate.html</a></p>
<pre class="{sql}"><code>-- pg_proc contains data for aggregate functions as well as plain functions
select * from pg_proc
-- pg_aggregate is an extension of pg_proc.
select * from pg_aggregate</code></pre>
</section>
<section id="list-users" class="level2">
<h2 class="anchored" data-anchor-id="list-users">List users</h2>
<pre class="{sql}"><code>SELECT rolname FROM pg_roles;</code></pre>
</section>
<section id="list-tables-in-database" class="level2">
<h2 class="anchored" data-anchor-id="list-tables-in-database">List tables in database</h2>
<pre class="{sql}"><code>SELECT table_schema,table_name FROM information_schema.tables ORDER BY table_schema,table_name;</code></pre>
</section>
<section id="list-columns-in-table" class="level2">
<h2 class="anchored" data-anchor-id="list-columns-in-table">List columns in table</h2>
<pre class="{sql}"><code>SELECT column_name
FROM   information_schema.columns
WHERE  table_schema = 'schema'
AND    table_name = 'table';</code></pre>
</section>
<section id="update-from" class="level2">
<h2 class="anchored" data-anchor-id="update-from">Update From</h2>
<pre class="{sql}"><code>UPDATE tablename
SET columnname = someothervalue
FROM ...
WHERE ...</code></pre>
</section>
<section id="materialized-view" class="level2">
<h2 class="anchored" data-anchor-id="materialized-view">Materialized View</h2>
<p><a href="https://www.postgresqltutorial.com/postgresql-materialized-views/">Reference</a></p>
<pre class="{sql}"><code>CREATE MATERIALIZED VIEW view_name
AS
query
WITH [NO] DATA;</code></pre>
<p>When you refresh data for a materialized view, PostgreSQL locks the entire table therefore you cannot query data against it. To avoid this, you can use the CONCURRENTLY option.</p>
<p>With CONCURRENTLY option, PostgreSQL creates a temporary updated version of the materialized view, compares two versions, and performs INSERT and UPDATE only the differences.</p>
<pre class="{sql}"><code>REFRESH MATERIALIZED VIEW CONCURRENTLY view_name;</code></pre>
</section>
<section id="constants" class="level2">
<h2 class="anchored" data-anchor-id="constants">Constants</h2>
<pre class="{sql}"><code>WITH myconstants (analyte_search) as (
   values ('%Hexachlorocyclopentadiene%')
)

SELECT *
FROM e_analyte, myconstants
WHERE analyte ilike analyte_search
   OR full_name ilike analyte_search
   OR aliases ilike analyte_search;</code></pre>
</section>
<section id="sequential-keys" class="level2">
<h2 class="anchored" data-anchor-id="sequential-keys">Sequential Keys</h2>
<pre class="{sql}"><code>seq_key bigint NOT NULL DEFAULT nextval('seq_key'::regclass)

ALTER SEQUENCE seq_key RESTART WITH 3;</code></pre>
</section>
<section id="cross-database-search" class="level2">
<h2 class="anchored" data-anchor-id="cross-database-search">Cross-Database Search</h2>
<p>This could be refined further by creating a function.</p>
<pre class="{sql}"><code>with
dbrows as (
    select * from dblink(
        'dbname=chemcrit',
        'select analyte, full_name, chem_class, aliases, cas_rn from e_analyte'
        ) as d (analyte text, full_name text, chem_class text, aliases text, cas_rn text)
  union
    select * from dblink(
        'dbname=ahtna',
        'select analyte, full_name, chem_class, aliases, cas_rn from e_analyte'
        ) as d (analyte text, full_name text, chem_class text, aliases text, cas_rn text)
  union
    select * from dblink(
    'dbname=arkema_ph',
    'select analyte, full_name, chem_class, aliases, cas_rn from e_analyte'
    ) as d (analyte text, full_name text, chem_class text, aliases text, cas_rn text)
  union
    select * from dblink(
    'dbname=bae_north',
    'select analyte, full_name, chem_class, aliases, cas_rn from e_analyte'
    ) as d (analyte text, full_name text, chem_class text, aliases text, cas_rn text)
  union
    select * from dblink(
    'dbname=bayer_ldw',
    'select analyte, full_name, chem_class, aliases, cas_rn from e_analyte'
    ) as d (analyte text, full_name text, chem_class text, aliases text, cas_rn text)
  union
    select * from dblink(
    'dbname=bcsa',
    'select analyte, full_name, chem_class, aliases, cas_rn from e_analyte'
    ) as d (analyte text, full_name text, chem_class text, aliases text, cas_rn text)
  union
    select * from dblink(
    'dbname=c840_livent',
    'select analyte, full_name, chem_class, aliases, cas_rn from e_analyte'
    ) as d (analyte text, full_name text, chem_class text, aliases text, cas_rn text)
  union
    select * from dblink(
    'dbname=cabotroad',
    'select analyte, full_name, chem_class, aliases, cas_rn from e_analyte'
    ) as d (analyte text, full_name text, chem_class text, aliases text, cas_rn text)
  union
    select * from dblink(
    'dbname=centralia',
    'select analyte, full_name, chem_class, aliases, cas_rn from e_analyte'
    ) as d (analyte text, full_name text, chem_class text, aliases text, cas_rn text)
  union
    select * from dblink(
    'dbname=centredale',
    'select analyte, full_name, chem_class, aliases, cas_rn from e_analyte'
    ) as d (analyte text, full_name text, chem_class text, aliases text, cas_rn text)
  union
    select * from dblink(
    'dbname=eos',
    'select analyte, full_name, chem_class, aliases, cas_rn from e_analyte'
    ) as d (analyte text, full_name text, chem_class text, aliases text, cas_rn text)
  union
    select * from dblink(
    'dbname=evraz_inwater',
    'select analyte, full_name, chem_class, aliases, cas_rn from e_analyte'
    ) as d (analyte text, full_name text, chem_class text, aliases text, cas_rn text)
  union
    select * from dblink(
    'dbname=frenchtown_mill',
    'select analyte, full_name, chem_class, aliases, cas_rn from e_analyte'
    ) as d (analyte text, full_name text, chem_class text, aliases text, cas_rn text)
  union
    select * from dblink(
    'dbname=gemt_columbus',
    'select analyte, full_name, chem_class, aliases, cas_rn from e_analyte'
    ) as d (analyte text, full_name text, chem_class text, aliases text, cas_rn text)
  union
    select * from dblink(
    'dbname=gemt_meridian',
    'select analyte, full_name, chem_class, aliases, cas_rn from e_analyte'
    ) as d (analyte text, full_name text, chem_class text, aliases text, cas_rn text)
  union
    select * from dblink(
    'dbname=gemt_springfield',
    'select analyte, full_name, chem_class, aliases, cas_rn from e_analyte'
    ) as d (analyte text, full_name text, chem_class text, aliases text, cas_rn text)
  union
    select * from dblink(
    'dbname=reddog',
    'select analyte, full_name, chem_class, aliases, cas_rn from e_analyte'
    ) as d (analyte text, full_name text, chem_class text, aliases text, cas_rn text)
  union
    select * from dblink(
    'dbname=shoreham',
    'select analyte, full_name, chem_class, aliases, cas_rn from e_analyte'
    ) as d (analyte text, full_name text, chem_class text, aliases text, cas_rn text)
  union
    select * from dblink(
    'dbname=solvay',
    'select analyte, full_name, chem_class, aliases, cas_rn from e_analyte'
    ) as d (analyte text, full_name text, chem_class text, aliases text, cas_rn text)
  union
    select * from dblink(
    'dbname=three_m_mb',
    'select analyte, full_name, chem_class, aliases, cas_rn from e_analyte'
    ) as d (analyte text, full_name text, chem_class text, aliases text, cas_rn text)
),
const (param) as (
    values ('%solid%')
)
select analyte, full_name, chem_class, cas_rn, aliases
from dbrows, const
where analyte ilike param
or full_name ilike param
or aliases ilike param
order by chem_class, analyte;</code></pre>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>